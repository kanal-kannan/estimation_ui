<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Creative Design Studios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="icon" type="image/x-icon" href="/assets/logo.png">
</head>
<body class="bg-white font-sans text-gray-900 min-h-screen">
  <div class="flex items-start justify-center min-h-screen p-4 sm:p-8">
    <main class="relative bg-white/60 backdrop-blur-lg shadow-xl w-full max-w-7xl p-6 sm:p-10 rounded-3xl">
      <div class="absolute rounded-tr-full bottom-0 left-0 -z-10 bg-gradient-to-r from-blue-400 to-blue-300/50 w-1/4 h-[100px]"></div>
      
      <!-- Header -->
      <header class="flex justify-between items-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-800 tracking-wide">Interior Work Estimator</h1>
      </header>

      <!-- Main Grid: Client Info Left + Add Product Right -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Client Info -->
        <div class="bg-blue-100/80 backdrop-blur-lg border-4 border-blue-300/20 p-6 rounded-2xl shadow-md">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Client Information</h2>
          <form class="space-y-4">
            <div>
              <label class="text-sm font-medium" for="clientName">Client Name</label>
              <input type="text" id="clientName" required class="w-full bg-white/60 focus:border-2 border-blue-300 outline-none rounded-lg px-4 py-2 mt-1 shadow-inner" placeholder="Enter Your Name" oninput="this.value = this.value.replace(/[^a-zA-Z\s]/g, '')" />
            </div>
            <div>
              <label class="text-sm font-medium" for="phoneNumber">Phone Number</label>
              <input type="tel" id="phoneNumber" maxlength="10" minlength="10" pattern="[0-9]{10}" required class="w-full bg-white/60 focus:border-2 border-blue-300 outline-none rounded-lg px-4 py-2 mt-1 shadow-inner" placeholder="Enter 10-digit number" title="Please enter exactly 10 digits" />
              <span id="phoneError" class="text-red-600 text-sm mt-1 hidden">Please enter correct mobile number</span>
            </div>
            <div>
              <label class="text-sm font-medium" for="dateInput">Date</label>
              <input type="date" id="dateInput" required class="w-full bg-white/60 focus:border-2 border-blue-300 outline-none rounded-lg px-4 py-2 mt-1 shadow-inner" />
            </div>
          </form>
          <!-- Total Amount -->
          <div class="mt-6 pt-4 border-t border-blue-300">
            <p class="text-lg font-semibold text-gray-800">Total Amount:</p>
            <p class="text-xl font-extrabold text-[#2c3e50]" id="totalAmount">₹0</p>
          </div>
        </div>

        <!-- Add Product Form -->
        <div class="bg-blue-50 p-6 rounded-2xl shadow-xl border-4 border-blue-200/50">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">Add Product</h2>
          </div>

          <form id="productForm" class="space-y-6">
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                <select id="product" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2">
                  <option value="">Select Product</option>
                  <option value="LOFT">Loft</option>
                  <option value="KITCHEN_KADAPA_SHELF">Kitchen Kadapa Shelf</option>
                  <option value="MODULAR_KITCHEN">Modular Kitchen</option>
                  <option value="KITCHEN_WALL_UNIT">Kitchen Wall Unit</option>
                  <option value="CROCKERY_UNIT">Crockery Unit</option>
                  <option value="POOJA_BOX">Pooja Box</option>
                  <option value="TV_UNIT">TV Unit</option>
                  <option value="PANELING_WORK">Panelling Work</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Structure</label>
                <select id="structure" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2">
                  <option value="">Select Structure</option>
                  <option value="MR_COMMERCIAL_PLYWOOD">MR Commercial Plywood</option>
                  <option value="BWR_PLYWOOD">BWR Plywood</option>
                  <option value="BWP_PLYWOOD">BWP Plywood</option>
                  <option value="MDF_PANEL">MDF Panel</option>
                  <option value="HMR_PANEL">HMR Panel</option>
                  <option value="HDHMR_PANEL">HD HMR Panel</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Finish</label>
                <select id="finish" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2">
                  <option value="">Select Finish</option>
                  <option value="PRELAM">Prelam</option>
                  <option value="LAMINATE">Laminate</option>
                  <option value="ACRYLIC">Acrylic</option>
                </select>
              </div>
            </div>

            <!-- Dimensions -->
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Length (ft)</label>
                <input type="number" id="length" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Breadth (ft)</label>
                <input type="number" id="breadth" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Rate (₹/unit)</label>
                <input type="number" id="rate" required class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2" />
              </div>
            </div>

            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Customer Notes</label>
              <textarea id="customerNotes" rows="3" placeholder="Any special instructions..." class="w-full border border-gray-300 focus:border-blue-500 rounded-lg px-4 py-2 resize-none"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4">
              <button type="reset" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancel</button>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow" id="generateEstimateBtn">
                <i class="fas fa-save mr-2"></i> Generate Estimate
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Estimation View Card -->
      <div id="estimationViewCard" class="mt-10 hidden bg-white border border-blue-200 p-6 rounded-xl shadow-md">
        <h3 class="text-lg font-bold mb-4 text-blue-700">Latest Estimation Details</h3>
        <div id="estimationDetails" class="space-y-2 text-gray-800 text-sm">
          <!-- Populated dynamically if needed -->
        </div>
      </div>

      <!-- Hidden PDF Link (if needed) -->
      <a id="pdfLink" class="hidden" download></a>

    </main>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="hidden"></div>

  <script>
    const productForm = document.getElementById("productForm");
    const pdfLink = document.getElementById("pdfLink");
    const generateEstimateBtn = document.getElementById("generateEstimateBtn");

    const clientInputs = {
      name: document.getElementById("clientName"),
      phoneNumber: document.getElementById("phoneNumber"),
      date: document.getElementById("dateInput")
    };

    let products = [];

    function showToast(message, color = "bg-green-500") {
      const toast = document.getElementById("toast");
      toast.className = `fixed top-5 right-5 text-white text-sm px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-300 ${color}`;
      toast.textContent = message;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
    }

    async function fetchProducts() {
      try {
        const response = await fetch("http://localhost:3000/api/estimations");
        if (!response.ok) throw new Error("Failed to fetch estimations");

        const data = await response.json();
        // You can update a list or table here if needed.
        showToast("Fetched estimations successfully!");
      } catch (err) {
        console.error(err);
        showToast("Error fetching estimations", "bg-red-500");
      }
    }

    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const productData = {
        product: document.getElementById("product").value,
        structure: document.getElementById("structure").value,
        finish: document.getElementById("finish").value,
        length: parseFloat(document.getElementById("length").value),
        breadth: parseFloat(document.getElementById("breadth").value),
        rate: parseFloat(document.getElementById("rate").value),
        customerNotes: document.getElementById("customerNotes").value
      };

      const clientData = {
        clientName: clientInputs.name.value,
        phoneNumber: clientInputs.phoneNumber.value,
        date: clientInputs.date.value
      };

      const hasEmpty = Object.values({ ...productData, ...clientData }).some(v => !v);
      if (hasEmpty) {
        showToast("All fields must be filled before submitting!", "bg-red-500");
        return;
      }

      const payload = { ...clientData, ...productData };

      try {
        const response = await fetch("http://localhost:3000/api/estimations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.error || "Failed to save estimation.");

        products.push(payload);
        // productForm.reset();
        updateSummary(result.amount);
        showToast("Estimation saved successfully!");

        // Automatically download the PDF
        const pdfUrl = `http://localhost:3000/api/estimations/${result.id}/pdf`;
        const tempLink = document.createElement("a");
        tempLink.href = pdfUrl;
        tempLink.download = `Estimation-${result.id}.pdf`;
        document.body.appendChild(tempLink);
        tempLink.click();
        document.body.removeChild(tempLink);

        fetchProducts(); // Optionally refresh the estimations list

      } catch (err) {
        showToast(`Error: ${err.message}`, "bg-red-500");
      }
    });

    function updateSummary(total) {
      document.getElementById("totalAmount").textContent = `₹${parseFloat(total).toFixed(2)}`;
    }

    // Set today's date automatically in the date input field
    const dateInput = document.getElementById("dateInput");
    if (dateInput) {
      const today = new Date().toISOString().split("T")[0];
      dateInput.value = today;
    }

    // Initial fetch of estimations (if needed)
    fetchProducts();
  </script>
</body>
</html>
